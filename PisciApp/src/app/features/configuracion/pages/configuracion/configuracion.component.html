<app-navbar></app-navbar>
<div class="configuracion">
  <h2>Configuraci√≥n</h2>

  <mat-accordion multi="false">
    <!-- PERFIL -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Perfil</mat-panel-title>
      </mat-expansion-panel-header>

      <form class="perfil-form" #f="ngForm" (ngSubmit)="actualizarPerfil()">
        <div *ngIf="user" class="perfil-grid">
          <!-- Nombre -->
          <mat-form-field appearance="outline">
            <mat-label>Nombre completo</mat-label>
            <input matInput [(ngModel)]="user.nombre" name="nombre" />
          </mat-form-field>

          <!-- Correo -->
          <mat-form-field appearance="outline">
            <mat-label>Correo electr√≥nico</mat-label>
            <input
              matInput
              type="email"
              [(ngModel)]="user.correo"
              name="correo"
            />
          </mat-form-field>

          <!-- Tel√©fono -->
          <mat-form-field appearance="outline">
            <mat-label>Tel√©fono</mat-label>
            <input
              matInput
              type="tel"
              [(ngModel)]="user.telefono"
              name="telefono"
            />
          </mat-form-field>

          <!-- Ciudad -->
          <mat-form-field appearance="outline">
            <mat-label>Ciudad</mat-label>
            <input matInput [(ngModel)]="user.ciudad" name="ciudad" />
          </mat-form-field>

          <!-- Departamento -->
          <mat-form-field appearance="outline">
            <mat-label>Departamento</mat-label>
            <input
              matInput
              [(ngModel)]="user.departamento"
              name="departamento"
            />
          </mat-form-field>

          <!-- Foto de perfil -->
          <div class="foto-perfil-upload">
            <label for="fotoPerfil" class="foto-label">
              <img
                *ngIf="user.foto_perfil; else defaultAvatar"
                [src]="user.foto_perfil"
                alt="Foto de perfil"
              />
              <ng-template #defaultAvatar>
                <mat-icon>account_circle</mat-icon>
              </ng-template>
            </label>
            <input
              type="file"
              id="fotoPerfil"
              name="foto_perfil"
              (change)="onFotoPerfilChange($event)"
              hidden
            />
            <p>Haz clic en el icono para cambiar tu foto de perfil</p>
          </div>
        </div>

        <div class="perfil-actions">
          <button mat-raised-button color="primary" type="submit">
            Actualizar perfil
          </button>
        </div>
      </form>
    </mat-expansion-panel>

    <!-- SEGURIDAD -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Seguridad</mat-panel-title>
      </mat-expansion-panel-header>

      <!-- CARD DE ESTADO -->
      <div
        class="status-card"
        [ngClass]="{
          enabled: user?.twofa_enabled,
          disabled: !user?.twofa_enabled
        }"
      >
        <div class="status-info">
          <div class="status-icon">
            {{ user?.twofa_enabled ? "üõ°Ô∏è" : "‚ö†Ô∏è" }}
          </div>
          <div class="status-text">
            <h4>Autenticaci√≥n de dos factores (2FA)</h4>
            <p>
              {{
                user?.twofa_enabled
                  ? "Tu cuenta est√° protegida con 2FA"
                  : "Activa 2FA para mayor seguridad"
              }}
            </p>
          </div>
        </div>
        <div
          class="status-badge"
          [ngClass]="user?.twofa_enabled ? 'active' : 'inactive'"
        >
          {{ user?.twofa_enabled ? "ACTIVO" : "INACTIVO" }}
        </div>
      </div>

      <!-- SI NO EST√Å ACTIVADO -->
      <div *ngIf="!user?.twofa_enabled" class="activation-section">
        <!-- BOT√ìN INICIAL DE ACTIVACI√ìN -->
        <div *ngIf="!qrCodeUrl" class="initial-action">
          <div class="action-info">
            <h5>¬øDeseas activar la autenticaci√≥n de dos factores?</h5>
            <p>A√±ade una capa extra de seguridad a tu cuenta.</p>
          </div>
          <div class="action-buttons">
            <button
              mat-raised-button
              color="primary"
              (click)="activar2FA()"
              [disabled]="isActivating2FA"
              class="btn-activate"
            >
              <!-- üî• SPINNER PARA ACTIVACI√ìN -->
              <mat-spinner
                *ngIf="isActivating2FA"
                diameter="18"
                class="button-spinner"
              >
              </mat-spinner>

              <mat-icon *ngIf="!isActivating2FA">security</mat-icon>
              {{ isActivating2FA ? "Activando..." : "Activar 2FA" }}
            </button>
          </div>
        </div>

        <!-- PROCESO DE CONFIGURACI√ìN -->
        <div *ngIf="qrCodeUrl" class="setup-process">
          <div class="setup-header">
            <h5>Configurar 2FA</h5>
            <p>
              Completa estos pasos para activar la autenticaci√≥n de dos
              factores:
            </p>
          </div>

          <div class="setup-steps">
            <!-- PASO 1: QR -->
            <div class="setup-step">
              <div class="step-info">
                <div class="step-number">1</div>
                <div class="step-details">
                  <h6>Escanea el c√≥digo QR</h6>
                  <p>Abre Google Authenticator y escanea este c√≥digo:</p>
                </div>
              </div>
              <div class="qr-display">
                <img [src]="qrCodeUrl" alt="QR Code 2FA" />
              </div>
            </div>

            <!-- PASO 2: VERIFICACI√ìN -->
            <div class="setup-step">
              <div class="step-info">
                <div class="step-number">2</div>
                <div class="step-details">
                  <h6>Introduce el c√≥digo</h6>
                  <p>Ingresa el c√≥digo de 6 d√≠gitos de tu aplicaci√≥n:</p>
                </div>
              </div>
              <div class="verification-area">
                <mat-form-field appearance="outline" class="code-input">
                  <mat-label>C√≥digo de verificaci√≥n</mat-label>
                  <input
                    matInput
                    [(ngModel)]="tokenInput"
                    maxlength="6"
                    placeholder="000000"
                    class="token-field"
                    [disabled]="isConfirming2FA"
                  />
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- BOTONES DE ACCI√ìN -->
          <div class="setup-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="confirmar2FA()"
              [disabled]="
                !tokenInput || tokenInput.length < 6 || isConfirming2FA
              "
              class="btn-confirm"
            >
              <!-- üî• SPINNER PARA CONFIRMACI√ìN -->
              <mat-spinner
                *ngIf="isConfirming2FA"
                diameter="18"
                class="button-spinner"
              >
              </mat-spinner>

              <mat-icon *ngIf="!isConfirming2FA">check</mat-icon>
              {{ isConfirming2FA ? "Confirmando..." : "Confirmar y Activar" }}
            </button>
          </div>
        </div>
      </div>

      <!-- SI YA EST√Å ACTIVADO -->
      <div *ngIf="user?.twofa_enabled" class="deactivation-section">
        <div class="deactivate-warning">
          <mat-icon class="warning-icon">error</mat-icon>
          <div class="warning-text">
            <h5>Desactivar 2FA</h5>
            <p>
              Esto reducir√° la seguridad de tu cuenta. Introduce tu c√≥digo
              actual para confirmar.
            </p>
          </div>
        </div>

        <div class="deactivate-form">
          <mat-form-field appearance="outline" class="code-input">
            <mat-label>C√≥digo de verificaci√≥n</mat-label>
            <input
              matInput
              [(ngModel)]="tokenInput"
              maxlength="6"
              placeholder="000000"
              class="token-field"
              [disabled]="isDeactivating2FA"
            />
          </mat-form-field>

          <div class="deactivate-actions">
            <button
              mat-raised-button
              color="warn"
              (click)="desactivar2FA()"
              [disabled]="
                !tokenInput || tokenInput.length < 6 || isDeactivating2FA
              "
              class="btn-deactivate"
            >
              <!-- üî• SPINNER PARA DESACTIVACI√ìN -->
              <mat-spinner
                *ngIf="isDeactivating2FA"
                diameter="18"
                class="button-spinner"
              >
              </mat-spinner>

              <mat-icon *ngIf="!isDeactivating2FA">no_encryption</mat-icon>
              {{ isDeactivating2FA ? "Desactivando..." : "Desactivar 2FA" }}
            </button>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- NOTIFICACIONES -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Notificaciones</mat-panel-title>
      </mat-expansion-panel-header>

      <div class="simple-notifications">
        <div class="simple-item">
          <mat-checkbox [(ngModel)]="notiEmail" name="notiEmail">
            Recibir notificaciones por correo electr√≥nico
          </mat-checkbox>
        </div>

        <div class="simple-item">
          <mat-checkbox [(ngModel)]="notiAlertas" name="notiAlertas">
            Alertas cr√≠ticas del sistema
          </mat-checkbox>
        </div>
      </div>

      <div class="actions">
        <button
          mat-raised-button
          color="primary"
          (click)="guardarNotificaciones()"
        >
          Guardar preferencias
        </button>
      </div>
    </mat-expansion-panel>

    <!-- PREFERENCIAS -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>Preferencias</mat-panel-title>
      </mat-expansion-panel-header>

      <div class="preferences-container">
        <div class="preference-item">
          <mat-form-field appearance="outline">
            <mat-label>Tema de la aplicaci√≥n</mat-label>
            <!-- üëá AQU√ç VA EL CAMBIO -->
            <mat-select
              [(ngModel)]="tema"
              name="tema"
              panelClass="select-ajustado"
            >
              <mat-option value="claro">üåû Modo claro</mat-option>
              <mat-option value="oscuro">üåô Modo oscuro</mat-option>
            </mat-select>
            <mat-icon matSuffix>palette</mat-icon>
          </mat-form-field>
        </div>

        <div class="preference-item">
          <mat-form-field appearance="outline">
            <mat-label>Idioma preferido</mat-label>
            <!-- üëá AQU√ç TAMBI√âN -->
            <mat-select
              [(ngModel)]="idioma"
              name="idioma"
              panelClass="select-ajustado"
            >
              <mat-option value="es">üá™üá∏ Espa√±ol</mat-option>
              <mat-option value="en">üá∫üá∏ Ingl√©s</mat-option>
            </mat-select>
            <mat-icon matSuffix>language</mat-icon>
          </mat-form-field>
        </div>
      </div>

      <div class="preference-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="guardarPreferencias()"
        >
          Guardar cambios
        </button>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>
